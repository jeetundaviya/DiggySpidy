{% extends 'base.html' %}

{% block title %}
Search
{% endblock %}
{% load static %}

{% block Enter_URL %}

<form class="" name="link_form" onsubmit="#" action="{% url 'home' %}" method="post">
    {% csrf_token %}

    <p style="text-align:left; margin: 5% 13% 0% 13%;">Drop an Onion Link</p>
    <div class="input-group">
        <div class="input-group-prepend">
            <span class="input-group-text">Enter Link</span>
        </div>

        <input type="text" class="form-control" name="link" value="" placeholder="Drop an Onion Link" autocomplete="off">

        <div class="input-group-append">
          <button type="submit" data-toggle="modal"  data-target ="#modal" name="button_link" value="button_link" class="btn btn-dark" >Submit Link</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modal_text" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modal_text"></h5>
          </div>
        </div>
      </div>
    </div>
</form>

{% if URL|length > 0 %}


  <nav class="card navbar navbar-dark bg-dark">
    <ul class="nav navbar-nav" style="flex-direction: row;">
      <li class="active"><a href="#" onclick="hideTable();">Data Dictonary</a></li>
      <li><a href="#" onclick="hideDataDictonary();">Table</a></li>
    </ul>
  </nav>

{% if Data_Dictonary != "None" %}


<div id="Table_Div" class="div_parent p-1">
  <p class="card-title" style="text-align:left; margin: 0% 0% 0% 13%;"><b>Table :- </b></p>
  <div id="Table_child" class="div_child card p-3 bg-dark text-white">
    <p class="card-text">{{Table|safe}}</p>
    </div>
    <button id="Copy_Table_Btn" type="button" class="Copy_Btn btn btn-danger ">
      <b>Download <span><img style="height: 25px;width:25px;" src="{% static 'assets/copy_icon.svg'%}"></span> </b>
</div>

<div id="Data_Dictonary_Div" class="div_parent p-1">
  <p class="card-title" style="text-align:left; margin: 0% 0% 0% 13%;"><b>Data dictionary :- </b></p>
  <div id="Data_Dictonary_child" class="div_child card p-3 bg-dark text-white">
  <p class="card-text">{{Data_Dictonary}}</p>
  </div>
  <button id="Copy_JSON_Btn" type="button" class="Copy_Btn btn btn-danger ">
    <b>Copy <span><img style="height: 25px;width:25px;" src="{% static 'assets/copy_icon.svg'%}"></span> </b>
</button>


<!-- Script for adding functionality for Downloading and Copying to clipboard ! -->

<script>
  document.getElementById("Table_Div").hidden = true;
  function hideTable(){
    document.getElementById("Table_Div").hidden = true;
    document.getElementById("Data_Dictonary_Div").hidden = false;
  }

  function hideDataDictonary(){
    document.getElementById("Table_Div").hidden = false;
    document.getElementById("Data_Dictonary_Div").hidden = true;
  }

  var Copy_JSON_Btn = document.getElementById("Copy_JSON_Btn")
  Copy_JSON_Btn.addEventListener("click", function() {
    copyToClipboard(document.getElementById("Data_Dictonary_child"),Copy_JSON_Btn);
});

var Copy_Table_Btn = document.getElementById("Copy_Table_Btn")
Copy_Table_Btn.addEventListener("click", function() {
  console.log("{{Excel_File_Location}}");
  window.open("{{Excel_File_Location}}");
  Copy_Table_Btn.innerText = "Downloaded !";
  Copy_Table_Btn.className = "Copy_Btn btn btn-success";
});

function downloadCSVFile(csv_data) {
 
//  // Create CSV file object and feed our
//  // csv_data into it
//  CSVFile = new Blob([csv_data], { type: "text/csv" });

//  // Create to temporary link to initiate
//  // download process
//  var temp_link = document.createElement('a');

//  // Download csv file
//  temp_link.download = "{{Only_URL}}.csv";
//  var url = window.URL.createObjectURL(CSVFile);
//  temp_link.href = url;

//  // This link should not be displayed
//  temp_link.style.display = "none";
//  document.body.appendChild(temp_link);

//  // Automatically click the link to trigger download
//  temp_link.click();
//  document.body.removeChild(temp_link);

 var temp_link = document.createElement('a');

 // Download csv file
 temp_link.download = "{{Only_URL}}.csv";
//  var url = window.URL.createObjectURL("{{CSV_File_Location}}");
 temp_link.href = "{{Excel_File_Location}}";

 // This link should not be displayed
 temp_link.style.display = "none";
 document.body.appendChild(temp_link);

 // Automatically click the link to trigger download
 temp_link.click();
 document.body.removeChild(temp_link);

}

function tableToCSV() {
 
 // Variable to store the final csv data
 var csv_data = [];
 // Get each row data
 var rows = document.getElementsByTagName('tr');

 for (var i = 0; i < rows.length; i++) {

     // Get each column data
     var cols = rows[i].querySelectorAll('td,th');

     // Stores each csv row data
     var csvrow = [];
     for (var j = 0; j < cols.length; j++) {

         // Get the text data of each cell of
         // a row and push it to csvrow
         csvrow.push(cols[j].innerText);
     }

     // Combine each column value with comma
     csv_data.push(csvrow.join(","));
 }
 // combine each row data with new line character
 csv_data = csv_data.join('\n');

 /* We will use this function later to download
 the data in a csv file downloadCSVFile(csv_data);
 */
return csv_data;
}

  function copyToClipboard(elem,copy_btn) {
	  navigator.clipboard.writeText(elem.innerText).then(function() {
      /* clipboard successfully set */
      copy_btn.innerText = "Copied !";
      copy_btn.className = "Copy_Btn btn btn-success";
    }, 
    function() {
      /* clipboard write failed */
      window.alert('Opps! Your browser does not support the Clipboard API');
    });
}

</script>

</div>

{% else %}

{% if ERROR_MSG != "" %}
<p style="text-align:left; margin: 5% 13% 0% 13%;"><b>Unable to scrape the {{URL}} !</b></p>
{% endif %}

{% endif %}

{% endif %}


{% endblock %}
